@page "/seasons"
@using ArenaService.Shared.Services
@using ArenaService.Shared.Models
@using ArenaService.Shared.Repositories
@inject ISeasonService SeasonService
@inject ISeasonCacheRepository SeasonCacheRepo

<h3>ğŸ† ì‹œì¦Œ ëª©ë¡</h3>

@if (loading)
{
    <p>ë¡œë”© ì¤‘...</p>
}
else
{
    <h4>í˜„ì¬ ì‹œì¦Œ</h4>
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>ì‹œì‘ ë¸”ë¡</th>
                <th>ì¢…ë£Œ ë¸”ë¡</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>@currentSeason?.Id</td>
                <td>@currentSeason?.StartBlock</td>
                <td>@currentSeason?.EndBlock</td>
            </tr>
        </tbody>
    </table>

    <h4>ğŸ“… ì‹œì¦Œ ëª©ë¡</h4>
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>ì‹œì‘ ë¸”ë¡</th>
                <th>ì¢…ë£Œ ë¸”ë¡</th>
                <th>íƒ€ì…</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var season in paginatedSeasons)
            {
                <tr>
                    <td>@season.Id</td>
                    <td>@season.StartBlock</td>
                    <td>@season.EndBlock</td>
                    <td>@season.ArenaType</td>
                </tr>
            }
        </tbody>
    </table>

    <div class="pagination">
        <button @onclick="PreviousPage" disabled="@(!CanGoPrevious)">ì´ì „</button>
        <span>í˜ì´ì§€ @(currentPage + 1) / @totalPages</span>
        <button @onclick="NextPage" disabled="@(!CanGoNext)">ë‹¤ìŒ</button>
    </div>
}

@code {
    private (int Id, long StartBlock, long EndBlock)? currentSeason;
    private List<Season> seasons = new();
    private List<Season> paginatedSeasons = new();
    private int currentPage = 0;
    private int pageSize = 5;
    private bool loading = true;

    private bool CanGoPrevious => currentPage > 0;
    private bool CanGoNext => (currentPage + 1) * pageSize < seasons.Count;
    private int totalPages => (seasons.Count + pageSize - 1) / pageSize;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Redisì—ì„œ í˜„ì¬ ì‹œì¦Œ ê°€ì ¸ì˜¤ê¸°
            currentSeason = await SeasonCacheRepo.GetSeasonAsync();

            // Redisì—ì„œ ë¸”ë¡ ì¸ë±ìŠ¤ ê°€ì ¸ì˜¤ê¸°
            long blockIndex = await SeasonCacheRepo.GetBlockIndexAsync();

            // ì‹œì¦Œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            seasons = await SeasonService.ClassifyByChampionship(blockIndex);

            UpdatePagination();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private void UpdatePagination()
    {
        paginatedSeasons = seasons.Skip(currentPage * pageSize).Take(pageSize).ToList();
    }

    private void NextPage()
    {
        if (CanGoNext)
        {
            currentPage++;
            UpdatePagination();
        }
    }

    private void PreviousPage()
    {
        if (CanGoPrevious)
        {
            currentPage--;
            UpdatePagination();
        }
    }
}
