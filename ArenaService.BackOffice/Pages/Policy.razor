@page "/policy"
@using ArenaService.Shared.Models.BattleTicket
@using ArenaService.Shared.Models.RefreshTicket
@using ArenaService.Shared.Repositories
@inject IBattleTicketPolicyRepository BattlePolicyRepo
@inject IRefreshTicketPolicyRepository RefreshPolicyRepo

<h3>ğŸŸï¸ í‹°ì¼“ ì •ì±… ê´€ë¦¬</h3>

<!-- ë°°í‹€ í‹°ì¼“ ì •ì±… ëª©ë¡ -->
<h4>âš”ï¸ ë°°í‹€ í‹°ì¼“ ì •ì±…</h4>
@if (battlePolicies == null)
{
    <p>ë¡œë”© ì¤‘...</p>
}
else if (!battlePolicies.Any())
{
    <p>ë“±ë¡ëœ ë°°í‹€ í‹°ì¼“ ì •ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>ì´ë¦„</th>
                <th>ë¼ìš´ë“œ ë³„ ê¸°ë³¸ ì§€ê¸‰ í‹°ì¼“</th>
                <th>ë¼ìš´ë“œ ë³„ ìµœëŒ€ êµ¬ë§¤ ê°€ëŠ¥ í‹°ì¼“</th>
                <th>ì‹œì¦Œ ë³„ ìµœëŒ€ êµ¬ë§¤ ê°€ëŠ¥ í‹°ì¼“</th>
                <th>êµ¬ë§¤ ê°€ê²©</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var policy in battlePolicies)
            {
                <tr>
                    <td>@policy.Id</td>
                    <td>@policy.Name</td>
                    <td>@policy.DefaultTicketsPerRound</td>
                    <td>@policy.MaxPurchasableTicketsPerRound</td>
                    <td>@policy.MaxPurchasableTicketsPerSeason</td>
                    <td>@string.Join(", ", policy.PurchasePrices)</td>
                </tr>
            }
        </tbody>
    </table>
}

<!-- ë¦¬í”„ë ˆì‹œ í‹°ì¼“ ì •ì±… ëª©ë¡ -->
<h4>ğŸ”„ ë¦¬í”„ë ˆì‹œ í‹°ì¼“ ì •ì±…</h4>
@if (refreshPolicies == null)
{
    <p>ë¡œë”© ì¤‘...</p>
}
else if (!refreshPolicies.Any())
{
    <p>ë“±ë¡ëœ ë¦¬í”„ë ˆì‹œ í‹°ì¼“ ì •ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>ì´ë¦„</th>
                <th>ë¼ìš´ë“œ ë³„ ê¸°ë³¸ ì§€ê¸‰ í‹°ì¼“</th>
                <th>ë¼ìš´ë“œ ë³„ ìµœëŒ€ êµ¬ë§¤ ê°€ëŠ¥ í‹°ì¼“</th>
                <th>êµ¬ë§¤ ê°€ê²©</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var policy in refreshPolicies)
            {
                <tr>
                    <td>@policy.Id</td>
                    <td>@policy.Name</td>
                    <td>@policy.DefaultTicketsPerRound</td>
                    <td>@policy.MaxPurchasableTicketsPerRound</td>
                    <td>@string.Join(", ", policy.PurchasePrices)</td>
                </tr>
            }
        </tbody>
    </table>
}

<hr />

<!-- ìƒˆë¡œìš´ í´ë¦¬ì‹œ ì¶”ê°€ -->
<h4>ğŸ†• ìƒˆ ì •ì±… ì¶”ê°€</h4>
<div class="form-group">
    <label>ì´ë¦„:</label>
    <input class="form-control" @bind="newPolicyName" />
</div>
<div class="form-group">
    <label>ë¼ìš´ë“œ ë³„ ê¸°ë³¸ ì§€ê¸‰ í‹°ì¼“:</label>
    <input class="form-control" type="number" @bind="newDefaultTickets" />
</div>
<div class="form-group">
    <label>ë¼ìš´ë“œ ë³„ ìµœëŒ€ êµ¬ë§¤ ê°€ëŠ¥ í‹°ì¼“:</label>
    <input class="form-control" type="number" @bind="newMaxPurchasableTicketsPerRound" />
</div>
<div class="form-group">
    <label>ì‹œì¦Œ ë³„ ìµœëŒ€ êµ¬ë§¤ ê°€ëŠ¥ í‹°ì¼“ (ë¦¬í”„ë ˆì‹œ í‹°ì¼“ì¼ ê²½ìš° ë¬´ì‹œë©ë‹ˆë‹¤.):</label>
    <input class="form-control" type="number" @bind="newMaxPurchasableTicketsPerSeason" />
</div>

<!-- êµ¬ë§¤ ê°€ê²© ì„¤ì • -->
<h5>ğŸ’° êµ¬ë§¤ ê°€ê²© ì„¤ì •</h5>
<div class="form-group">
    <label>ì´ˆê¸° ê°€ê²©:</label>
    <input class="form-control" type="number" step="0.1" @bind="initialPrice" />
</div>
<div class="form-group">
    <label>ê°€ê²© ì¦ê°€ ê°’:</label>
    <input class="form-control" type="number" step="0.1" @bind="priceStep" />
</div>

<!-- ë°°í‹€ í‹°ì¼“ìš© ìë™ ìƒì„± ë²„íŠ¼ -->
<button class="btn btn-secondary" @onclick="GenerateBattlePrices">âš”ï¸ ë°°í‹€ í‹°ì¼“ ê°€ê²© ìë™ ìƒì„±</button>

<!-- ë¦¬í”„ë ˆì‹œ í‹°ì¼“ìš© ìë™ ìƒì„± ë²„íŠ¼ -->
<button class="btn btn-secondary" @onclick="GenerateRefreshPrices">ğŸ”„ ë¦¬í”„ë ˆì‹œ í‹°ì¼“ ê°€ê²© ìë™ ìƒì„±</button>

<!-- ì§ì ‘ ì…ë ¥ ê°€ëŠ¥ -->
<div class="form-group">
    <label>êµ¬ë§¤ ê°€ê²© ë¦¬ìŠ¤íŠ¸:</label>
    <textarea class="form-control" @bind="manualPrices"></textarea>
</div>

<button class="btn btn-primary" @onclick="AddBattlePolicy">âš”ï¸ ë°°í‹€ í‹°ì¼“ ì •ì±… ì¶”ê°€</button>
<button class="btn btn-success" @onclick="AddRefreshPolicy">ğŸ”„ ë¦¬í”„ë ˆì‹œ í‹°ì¼“ ì •ì±… ì¶”ê°€</button>

@if (message is not null)
{
    <p class="text-info">@message</p>
}

@code {
    private List<BattleTicketPolicy>? battlePolicies;
    private List<RefreshTicketPolicy>? refreshPolicies;
    private string newPolicyName = "";
    private int newDefaultTickets;
    private int newMaxPurchasableTicketsPerRound;
    private int newMaxPurchasableTicketsPerSeason;
    private string? message;

    private decimal initialPrice = 1.0m;
    private decimal priceStep = 0.1m;
    private string manualPrices = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadPolicies();
    }

    private async Task LoadPolicies()
    {
        battlePolicies = await BattlePolicyRepo.GetAllBattlePoliciesAsync();
        refreshPolicies = await RefreshPolicyRepo.GetAllRefreshPoliciesAsync();
    }

    private async Task AddBattlePolicy()
    {
        var prices = ParsePrices(newMaxPurchasableTicketsPerSeason);
        var policy = new BattleTicketPolicy
        {
            Name = newPolicyName,
            DefaultTicketsPerRound = newDefaultTickets,
            MaxPurchasableTicketsPerRound = newMaxPurchasableTicketsPerRound,
            MaxPurchasableTicketsPerSeason = newMaxPurchasableTicketsPerSeason,
            PurchasePrices = prices
        };

        await BattlePolicyRepo.AddBattlePolicyAsync(policy);
        message = "âœ… ë°°í‹€ í‹°ì¼“ ì •ì±…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!";
        await LoadPolicies();
    }

    private async Task AddRefreshPolicy()
    {
        var prices = ParsePrices(newMaxPurchasableTicketsPerRound);
        var policy = new RefreshTicketPolicy
        {
            Name = newPolicyName,
            DefaultTicketsPerRound = newDefaultTickets,
            MaxPurchasableTicketsPerRound = newMaxPurchasableTicketsPerRound,
            PurchasePrices = prices
        };

        await RefreshPolicyRepo.AddRefreshPolicyAsync(policy);
        message = "âœ… ë¦¬í”„ë ˆì‹œ í‹°ì¼“ ì •ì±…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!";
        await LoadPolicies();
    }

    private void GenerateBattlePrices()
    {
        var prices = GenerateSequence(newMaxPurchasableTicketsPerSeason, initialPrice, priceStep);
        manualPrices = string.Join(", ", prices);
    }

    private void GenerateRefreshPrices()
    {
        var prices = GenerateSequence(newMaxPurchasableTicketsPerRound, initialPrice, priceStep);
        manualPrices = string.Join(", ", prices);
    }

    private List<decimal> ParsePrices(int length)
    {
        return manualPrices.Split(',')
            .Select(p => decimal.TryParse(p.Trim(), out var result) ? result : (decimal?)null)
            .Where(p => p.HasValue)
            .Select(p => p!.Value)
            .ToList();
    }

    private List<decimal> GenerateSequence(int length, decimal start, decimal step)
    {
        return Enumerable.Range(0, length)
            .Select(i => Math.Round(start + step * i, 1))
            .ToList();
    }
}
