@page "/manage-seasons"
@using ArenaService.Shared.Repositories
@using ArenaService.Shared.Services
@using ArenaService.Shared.Models
@using Microsoft.EntityFrameworkCore
@inject ISeasonRepository SeasonRepo
@inject ISeasonCacheRepository SeasonCacheRepo
@inject IRankingRepository RankingRepo
@inject IRoundRepository RoundRepo
@inject ISeasonPreparationService SeasonPreparationService
@inject IRoundPreparationService RoundPreparationService
@inject NavigationManager NavigationManager

<h3>ğŸ† ì‹œì¦Œ ê´€ë¦¬</h3>

<!-- ì§„í–‰ ì¤‘ì¸ ì‹œì¦Œ ì •ë³´ -->
<h4>ğŸ“… í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‹œì¦Œ</h4>
@if (currentSeason != null)
{
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>ì‹œì‘ ë¸”ë¡</th>
                <th>ì¢…ë£Œ ë¸”ë¡</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>@currentSeason?.Id</td>
                <td>@currentSeason?.StartBlock</td>
                <td>@currentSeason?.EndBlock</td>
            </tr>
        </tbody>
    </table>

    <h4>ğŸ“… í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë¼ìš´ë“œ</h4>
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>ì‹œì‘ ë¸”ë¡</th>
                <th>ì¢…ë£Œ ë¸”ë¡</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>@currentRound?.Id</td>
                <td>@currentRound?.StartBlock</td>
                <td>@currentRound?.EndBlock</td>
            </tr>
        </tbody>
    </table>

    <h4>ğŸ“Š ë­í‚¹ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€</h4>
    <table class="table">
        <thead>
            <tr>
                <th>ë¼ìš´ë“œ</th>
                <th>ë­í‚¹ ë°ì´í„° ê°œìˆ˜</th>
                <th>ìƒíƒœ</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var roundRanking in rankingCounts)
            {
                <tr>
                    <td>@roundRanking.RoundOffset</td>
                    <td>@roundRanking.RankingCount</td>
                    <td>@(roundRanking.RankingCount > 0 ? "âœ… ì¤€ë¹„ë¨" : "âŒ ë¯¸ì™„ë£Œ")</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>âš ï¸ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‹œì¦Œì´ ì—†ìŠµë‹ˆë‹¤.</p>
}

<hr />

<!-- ì‹œì¦Œ ì´ˆê¸°í™” -->
<div class="form-group">
    <label for="seasonId">ì‹œì¦Œ ID:</label>
    <input id="seasonId" class="form-control" @bind="seasonId" type="number" />
</div>

<button class="btn btn-primary" @onclick="InitializeSeason">ì‹œì¦Œ ì´ˆê¸°í™”</button>

@if (seasonMessage is not null)
{
    <p class="text-info">@seasonMessage</p>
}

<hr />

<!-- ë¼ìš´ë“œ ì¤€ë¹„ -->
<div class="form-group">
    <label for="roundId">(ì§„í–‰ì¤‘ì¸ ë¼ìš´ë“œì™€ +1í•œ ë¼ìš´ë“œë¥¼ ì¤€ë¹„í•˜ëŠ”ê²ë‹ˆë‹¤. ì˜ˆë¥¼ë“¤ì–´ 42ë¼ìš´ë“œê°€ ì§„í–‰ì¤‘ì¸ë° 43ë¼ìš´ë“œê°€ ì¤€ë¹„ë˜ì–´ìˆì§€ ì•Šë‹¤ë©´ 42ë¼ìš´ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.) ë¼ìš´ë“œ
        ID:</label>
    <input id="roundId" class="form-control" @bind="roundId" type="number" />
</div>

<button class="btn btn-success" @onclick="PrepareNextRound">ë¼ìš´ë“œ ì¤€ë¹„</button>

@if (roundMessage is not null)
{
    <p class="text-info">@roundMessage</p>
}

@code {
    private (int Id, long StartBlock, long EndBlock)? currentSeason;
    private (int Id, long StartBlock, long EndBlock)? currentRound;
    private List<(int RoundOffset, int RankingCount)> rankingCounts = new();
    private int seasonId;
    private int roundId;
    private string? seasonMessage;
    private string? roundMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentSeason = await SeasonCacheRepo.GetSeasonAsync();
            currentRound = await SeasonCacheRepo.GetRoundAsync();

            if (currentSeason.HasValue && currentRound.HasValue)
            {
                await LoadRankingCounts(currentSeason.Value.Id, currentRound.Value.Id);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âš ï¸ ì§„í–‰ ì¤‘ì¸ ì‹œì¦Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {ex.Message}");
        }
    }

    private async Task LoadRankingCounts(int seasonId, int currentRoundId)
    {
        rankingCounts.Clear();

        for (int offset = -1; offset <= 2; offset++)
        {
            int roundToCheck = currentRoundId + offset;
            int rankingCount = await RankingRepo.GetRankingCountAsync(seasonId, roundToCheck);
            rankingCounts.Add((currentRoundId + offset, rankingCount));
        }
    }

    private async Task InitializeSeason()
    {
        seasonMessage = "ì‹œì¦Œ ì´ˆê¸°í™” ì¤‘...";
        try
        {
            var season = await SeasonRepo.GetSeasonAsync(seasonId, q => q.Include(s => s.Rounds));

            if (season == null)
            {
                seasonMessage = "âŒ ì‹œì¦Œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }

            var firstRound = season.Rounds.OrderBy(r => r.StartBlock).FirstOrDefault();

            if (firstRound == null)
            {
                seasonMessage = "âš ï¸ í•´ë‹¹ ì‹œì¦Œì— ë¼ìš´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }

            await SeasonPreparationService.PrepareSeasonAsync((season, firstRound));

            seasonMessage = "âœ… ì‹œì¦Œ ì´ˆê¸°í™” ì™„ë£Œ!";
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }
        catch (Exception ex)
        {
            seasonMessage = $"âŒ ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
        }
    }

    private async Task PrepareNextRound()
    {
        roundMessage = "ë¼ìš´ë“œ ì¤€ë¹„ ì¤‘...";
        try
        {
            var round = await RoundRepo.GetRoundAsync(roundId, q => q.Include(r => r.Season));
            var season = await SeasonRepo.GetSeasonAsync(round!.SeasonId, q => q.Include(s => s.Rounds));

            if (round == null || round.Season == null)
            {
                roundMessage = "âŒ ë¼ìš´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }

            await RoundPreparationService.PrepareNextRoundWithSnapshotAsync((season, round));

            roundMessage = "âœ… ë‹¤ìŒ ë¼ìš´ë“œ ì¤€ë¹„ ì™„ë£Œ!";
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }
        catch (Exception ex)
        {
            roundMessage = $"âŒ ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
        }
    }
}
