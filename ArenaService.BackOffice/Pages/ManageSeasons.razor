@page "/manage-seasons"
@using ArenaService.Shared.Repositories
@using ArenaService.Shared.Services
@using ArenaService.Shared.Models
@using Microsoft.EntityFrameworkCore
@inject ISeasonRepository SeasonRepo
@inject IRoundRepository RoundRepo
@inject ISeasonPreparationService SeasonPreparationService
@inject IRoundPreparationService RoundPreparationService

<h3>ğŸ† ì‹œì¦Œ ê´€ë¦¬</h3>

<!-- ì‹œì¦Œ ì´ˆê¸°í™” -->
<div class="form-group">
    <label for="seasonId">ì‹œì¦Œ ID:</label>
    <input id="seasonId" class="form-control" @bind="seasonId" type="number" />
</div>

<button class="btn btn-primary" @onclick="InitializeSeason">ì‹œì¦Œ ì´ˆê¸°í™”</button>

@if (seasonMessage is not null)
{
    <p class="text-info">@seasonMessage</p>
}

<hr />

<!-- ë‹¤ìŒ ë¼ìš´ë“œ ì¤€ë¹„ -->
<div class="form-group">
    <label for="roundId">ë¼ìš´ë“œ ID:</label>
    <input id="roundId" class="form-control" @bind="roundId" type="number" />
</div>

<button class="btn btn-success" @onclick="PrepareNextRound">ë‹¤ìŒ ë¼ìš´ë“œ ì¤€ë¹„</button>

@if (roundMessage is not null)
{
    <p class="text-info">@roundMessage</p>
}

@code {
    private int seasonId;
    private int roundId;
    private string? seasonMessage;
    private string? roundMessage;

    private async Task InitializeSeason()
    {
        seasonMessage = "ì‹œì¦Œ ì´ˆê¸°í™” ì¤‘...";
        try
        {
            var season = await SeasonRepo.GetSeasonAsync(seasonId, q => q.Include(s => s.Rounds));

            if (season == null)
            {
                seasonMessage = "âŒ ì‹œì¦Œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }

            var firstRound = season.Rounds.OrderBy(r => r.StartBlock).FirstOrDefault();

            if (firstRound == null)
            {
                seasonMessage = "âš ï¸ í•´ë‹¹ ì‹œì¦Œì— ë¼ìš´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }

            await SeasonPreparationService.PrepareSeasonAsync((season, firstRound));

            seasonMessage = "âœ… ì‹œì¦Œ ì´ˆê¸°í™” ì™„ë£Œ!";
        }
        catch (Exception ex)
        {
            seasonMessage = $"âŒ ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
        }
    }

    private async Task PrepareNextRound()
    {
        roundMessage = "ë¼ìš´ë“œ ì¤€ë¹„ ì¤‘...";
        try
        {
            var round = await RoundRepo.GetRoundAsync(roundId, q => q.Include(r => r.Season));

            if (round == null || round.Season == null)
            {
                roundMessage = "âŒ ë¼ìš´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }

            await RoundPreparationService.PrepareNextRoundWithSnapshotAsync((round.Season, round));

            roundMessage = "âœ… ë‹¤ìŒ ë¼ìš´ë“œ ì¤€ë¹„ ì™„ë£Œ!";
        }
        catch (Exception ex)
        {
            roundMessage = $"âŒ ì˜¤ë¥˜ ë°œìƒ: {ex.Message}";
        }
    }
}
