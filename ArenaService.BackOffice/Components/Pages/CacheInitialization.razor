@page "/cache-initialization"
@using ArenaService.Shared.Services
@using ArenaService.Shared.Repositories
@using ArenaService.Shared.Models
@inject ICacheInitializationService CacheInitializationService
@inject ISeasonCacheRepository SeasonCacheRepo
@inject IRankingRepository RankingRepo

<PageTitle>ìºì‹œ ì´ˆê¸°í™”</PageTitle>

<div class="container mt-4">
    <h2>ğŸ”„ ìºì‹œ ì´ˆê¸°í™”</h2>
    
    <!-- í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‹œì¦Œ ì •ë³´ -->
    <h4>ğŸ“… í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‹œì¦Œ</h4>
    @if (currentSeason != null)
    {
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ì‹œì‘ ë¸”ë¡</th>
                    <th>ì¢…ë£Œ ë¸”ë¡</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>@currentSeason?.Id</td>
                    <td>@currentSeason?.StartBlock</td>
                    <td>@currentSeason?.EndBlock</td>
                </tr>
            </tbody>
        </table>

        <h4>ğŸ“… í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë¼ìš´ë“œ</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ë¼ìš´ë“œ ì¸ë±ìŠ¤</th>
                    <th>ì‹œì‘ ë¸”ë¡</th>
                    <th>ì¢…ë£Œ ë¸”ë¡</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>@currentRound?.Id</td>
                    <td>@currentRound?.RoundIndex</td>
                    <td>@currentRound?.StartBlock</td>
                    <td>@currentRound?.EndBlock</td>
                </tr>
            </tbody>
        </table>

        <h4>ğŸ“Š ë­í‚¹ ë°ì´í„° ê°€ìš©ì„±</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>ë¼ìš´ë“œ</th>
                    <th>ë­í‚¹ ë°ì´í„° ìˆ˜</th>
                    <th>ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var roundRanking in rankingCounts)
                {
                    <tr>
                        <td>@roundRanking.RoundIndex</td>
                        <td>@roundRanking.RankingCount</td>
                        <td>@(roundRanking.RankingCount > 0 ? "âœ… ì¤€ë¹„ë¨" : "âŒ ë¶ˆì™„ì „")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p>âš ï¸ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‹œì¦Œì´ ì—†ìŠµë‹ˆë‹¤.</p>
    }

    <hr />

    <!-- ì „ì²´ ìºì‹œ ì´ˆê¸°í™” -->
    <div class="card">
        <div class="card-header">
            <h5>ğŸ—‘ï¸ ì „ì²´ ìºì‹œ ì´ˆê¸°í™”</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">ëª¨ë“  ë­í‚¹ ìºì‹œë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <button class="btn btn-danger" @onclick="InitializeAllCache" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span>ì²˜ë¦¬ ì¤‘...</span>
                }
                else
                {
                    <span>ì „ì²´ ìºì‹œ ì´ˆê¸°í™”</span>
                }
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert @alertClass mt-3" role="alert">
            @message
        </div>
    }
</div>

@code {
    private bool isLoading = false;
    private string message = "";
    private string alertClass = "";
    private (int Id, long StartBlock, long EndBlock)? currentSeason;
    private (int Id, int RoundIndex, long StartBlock, long EndBlock)? currentRound;
    private List<(int RoundOffset, int RankingCount)> rankingCounts = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentSeason = await SeasonCacheRepo.GetSeasonAsync();
            currentRound = await SeasonCacheRepo.GetRoundAsync();

            if (currentSeason.HasValue && currentRound.HasValue)
            {
                await LoadRankingCounts(currentSeason.Value.Id, currentRound.Value.RoundIndex);
            }
        }
        catch (Exception ex)
        {
            message = $"ì‹œì¦Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}";
            alertClass = "alert-danger";
        }
    }

    private async Task LoadRankingCounts(int seasonId, int currentRoundIndex)
    {
        rankingCounts.Clear();

        for (int offset = -1; offset <= 2; offset++)
        {
            int rankingCount = await RankingRepo.GetRankingCountAsync(seasonId, currentRoundIndex + offset);
            rankingCounts.Add((currentRoundIndex + offset, rankingCount));
        }
    }

    private async Task InitializeAllCache()
    {
        isLoading = true;
        message = "";
        
        try
        {
            var result = await CacheInitializationService.InitializeAllCacheAsync();
            
            if (result)
            {
                message = "ëª¨ë“  ë­í‚¹ ìºì‹œê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.";
                alertClass = "alert-success";
                
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìµœì‹  ì •ë³´ í‘œì‹œ
                await Task.Delay(1000);
                await LoadRankingCounts(currentSeason!.Value.Id, currentRound!.Value.RoundIndex);
            }
            else
            {
                message = "ìºì‹œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                alertClass = "alert-danger";
            }
        }
        catch (Exception ex)
        {
            message = $"ìºì‹œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {ex.Message}";
            alertClass = "alert-danger";
        }
        finally
        {
            isLoading = false;
        }
    }
} 